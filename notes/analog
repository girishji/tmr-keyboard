- comparator no good
- do not use GPIO to power the sensors
- use pull-down resistors so do not leave pin floating when TMR is off

---

## 3ï¸âƒ£ Recommended timing budget (safe)

For **100 Âµs total ON time**, do:

| Phase            | Time         |
| ---------------- | ------------ |
| Power-on         | 0 Âµs         |
| Settling         | **50â€“70 Âµs** |
| Sample / compare | **10â€“20 Âµs** |
| Power-off        | remainder    |

This leaves little margin â€” so timing must be deterministic.

---

## 4ï¸âƒ£ How to power-gate the sensor (correctly)

### Best method: **Load switch / PMOS**

Do **not** power the sensor directly from a GPIO.

```
VDD â”€â”€ P-MOSFET â”€â”€ TMR VDD
         â†‘
      GPIO
```

* Choose a **low-leakage, low-Rds(on)** PMOS
* Gate pulled high by default â†’ OFF in sleep
* GPIO pulls gate low to turn sensor ON

This ensures:
âœ” Clean supply
âœ” No back-powering through I/O
âœ” ÂµA-level leakage when off

---

## 5ï¸âƒ£ How to time this on nRF54L15 (low power)

### Use **RTC + DPPI** (no CPU jitter)

1. RTC fires every 10 ms
2. DPPI turns on sensor power GPIO
3. RTC compare (after ~70 Âµs) triggers ADC sample or comparator enable
4. RTC compare (after 100 Âµs) turns sensor power OFF

This keeps:

* CPU asleep
* Timing deterministic
* Power minimal

---

## 6ï¸âƒ£ Comparator vs ADC with power-gated sensor

### Comparator

âŒ Not ideal here

* Comparator needs stable input
* Turning it on/off repeatedly risks false triggers
* Best for *always-on* signals

### ADC (recommended)

âœ” ADC samples at a known instant
âœ” Can discard first sample
âœ” Works well with burst-mode sensing

---

## 7ï¸âƒ£ Average current calculation (realistic)

Assume:

* Sensor current: **300 ÂµA ON**
* Duty: 1%

[
I_\text{avg} = 300 ÂµA Ã— 0.01 = 3 ÂµA
]

Add:

* ADC bursts: negligible
* RTC + DPPI: <1 ÂµA
* MCU sleep: ~1â€“2 ÂµA

â¡ï¸ **Total â‰ˆ 5â€“6 ÂµA**
Very reasonable for a BLE keyboard.
(for 72 switches, a 4000mah battery will last over a year)
---

## 8ï¸âƒ£ Important layout details

âœ” Avoid floating inputs when sensor off (use pulldown or ADC disable)

---

Q: what does this mean: ADC bursts: negligible don't ADC reading of 8 pins consume current


## What â€œADC bursts: negligibleâ€ really means

It means:

> **The ADC draws a relatively large current, but only for a *very short time*. When averaged over 10 ms, that current contributes very little to the total.**

So â€œnegligibleâ€ refers to **average current**, not instantaneous current.

---

## Instantaneous vs average current (key concept)

### Instantaneous (when ADC is ON)

* ADC + analog front end may draw **hundreds of ÂµA to ~1 mA**
* This lasts for **microseconds**

### Average (over 10 ms period)

* ADC is ON for a tiny fraction of time
* Average contribution becomes very small

---

## Letâ€™s do the math for your case (8 channels)

### Assumptions (conservative)

* ADC current while active: **500 ÂµA**
* ADC time per sample: **5 Âµs**
* 8 channels â†’ **40 Âµs total**
* Sampling period: **10 ms**

### Average ADC current

[
I_{avg} = I_{on} \times \frac{t_{on}}{T}
= 500 ÂµA \times \frac{40 Âµs}{10 ms}
= 500 ÂµA \times 0.004
= 2 ÂµA
]

â¡ï¸ **~2 ÂµA average**

Thatâ€™s already smaller than:

* Sensor average current (~3 ÂµA)
* Comparable to MCU sleep current

And this is **worst-case**.

---

## In practice, itâ€™s usually lower

Because:

* ADC conversion can be **<2â€“3 Âµs** per channel
* You can oversample less
* You can disable ADC immediately after burst

---

## Important implementation detail (this matters)

To keep ADC current negligible, you must:

1ï¸âƒ£ **Fully disable ADC after burst**
(not just stop conversions)

2ï¸âƒ£ **Use single-ended, minimal resolution needed**
(no oversampling unless required)

4ï¸âƒ£ **Discard first sample if needed**
(after sensor power-up)


---

### 2. Why Direct GPIO is *Still* Not Recommended

Even though $2.4 \text{ mA}$ is within the nominal current limits of a single $\text{nRF54L15}$ $\text{GPIO}$ pin, directly powering the sensors is still discouraged for several key reasons:

* **Stability of $V_{\text{DD}}$:** The $\text{GPIO}$ output driver adds series resistance. When $2.4 \text{ mA}$ flows, this resistance causes a voltage drop ($\Delta V = I \cdot R_{\text{series}}$). This voltage drop can make the supply voltage to your TMR sensors unstable or lower than the intended $\text{V}_{\text{DD}}$, which affects the sensor's analog output accuracy.
* **Protection:** Using an external $\text{FET}$ isolates the $\text{MCU}$'s delicate I/O circuitry from any potential short circuit or transient spike on the sensor power rail.
* **Total System Current:** You have 9 banks, and while you only turn on one bank at a time, using 9 separate $\text{GPIO}$ pins to source current adds up to the total current limit for the entire $\text{MCU}$ package, which is a hard limit you must respect.

### 3. The Required Solution: A Small-Signal MOSFET or Load Switch

Since your current is low ($2.4 \text{ mA}$), you do not need a large, high-power $\text{FET}$. You can use a very small, low-$\text{R}_{\text{DS(on)}}$ **small-signal $\text{MOSFET}$ or a tiny dedicated Load Switch IC** for each of the 9 banks.

| Component Type | Advantages for $2.4 \text{ mA}$ |
| :--- | :--- |
| **Small-Signal $\text{MOSFET}$ ($\text{P-FET}$)** | **Cheapest and smallest.** Provides extremely low resistance ($\text{R}_{\text{DS(on)}}$) so the voltage drop ($\Delta V$) across the switch is negligible. |
| **Integrated Load Switch IC** | **Easiest to use.** Often includes internal protection (thermal shutdown, current limiting) and a clean $\text{ON/OFF}$ driver, simplifying the circuit design. |


Q: i have 9 tmr sensors outputs connected to 1 Analog pin of mcu. only one tmr will be ON at any time. others are not powered. do i need a pull-down, and if so where


Short, correct answer first:

**Yes â€” you should add a pull-down resistor, and it should be placed at the MCU ADC pin.**

Now letâ€™s explain *why*, *what value*, and *what not to do*, given your exact topology.

---

## Your topology (important)

* 9 Ã— TMR sensors
* All outputs tied together â†’ **one ADC pin**
* **Only one sensor is powered at any time**
* Other 8 sensors are completely unpowered

This is a classic **wired-analog bus**.

---

## Why a pull-down IS needed in this case

### 1ï¸âƒ£ When all sensors are OFF

* ADC pin would otherwise be **floating**
* Floating ADC pin causes:

  * Random readings
  * Extra ADC current
  * Noise pickup
  * Possible false wakeups

A pull-down gives the ADC a **defined idle state**.

---

### 2ï¸âƒ£ When one sensor is ON

* The active sensor **strongly drives** the line
* A **megaohm pull-down barely loads it**
* Measurement accuracy is not affected

---

### 3ï¸âƒ£ Prevents back-powering through ESD diodes

Even if a sensor is â€œoffâ€, its output pin may have:

* ESD diodes to VDD/GND
* Internal parasitics

The pull-down helps ensure:

* The bus voltage doesnâ€™t float high
* No current sneaks into unpowered sensors

---

## Where exactly should the pull-down go?

### âœ… **At the MCU side, as close to the ADC pin as possible**

```
TMR1 OUT â”€â”
TMR2 OUT â”€â”¤
...       â”œâ”€â”€â”€ Analog bus â”€â”€â”¬â”€â”€ ADC (nRF54L15)
TMR9 OUT â”€â”˜                 |
                            |
                          1â€“10 MÎ©
                            |
                           GND
```

**Reasons:**

* Defines the voltage *seen by the ADC*
* Keeps the entire bus quiet when idle
* Minimizes EMI pickup on a long trace

---

## Recommended pull-down value

### âœ” **1 MÎ© â€“ 10 MÎ©**

Best practical choices:

* **4.7 MÎ©** (very common)
* **10 MÎ©** (minimum loading, more noise sensitive)

### Current impact (worst case)

Assume:

* Sensor output = 1 V
* Pull-down = 4.7 MÎ©

[
I = \frac{1V}{4.7MÎ©} â‰ˆ 0.21 ÂµA
]

But:

* Sensor is ON only **100 Âµs every 10 ms (1%)**
* Average current â‰ˆ **2 nA** â†’ negligible

---

## Do you need pull-downs at each sensor?

âŒ **No. Do NOT put pull-downs at each sensor.**

Reasons:

* Unnecessary
* Increases loading
* Increases total leakage
* Does not improve stability

**One pull-down at the ADC is enough.**

---

## Important: add a small series resistor (recommended)

Because you are tying multiple outputs together:

```
Each sensor OUT â”€â”€ 100â€“330 Î© â”€â”€ analog bus
```

Why:

* Prevents output contention during switching
* Limits inrush if timing overlaps
* Improves ESD robustness
* Negligible voltage drop

This is *very* good practice for wired-analog buses.

---

## What about internal MCU pull-downs?

âŒ Donâ€™t rely on them:

* Usually too strong (10â€“50 kÎ©)
* Waste power
* Distort readings
* Often disabled in analog mode anyway

Use an **external megaohm resistor**.

---

Value Selection: High ImpedanceYou need a relatively high-value pull-down
resistor (e.g., $\mathbf{100 \text{ k}\Omega}$ to $\mathbf{1 \text{
M}\Omega}$).Rationale: The resistor must be large enough so that when the
single $\text{TMR}$ sensor is $\text{ON}$ and driving the pin, it doesn't have
to fight the pull-down resistor (which would waste power).It must be small
enough to effectively drain any residual charge or coupled noise when the
$\text{TMR}$ sensor's output is $\text{LOW}$ or when the system is
transitioning.

Q: combine the above pulldown resistor with RC circuit. Good â€” with **30 cm analog traces**, a **shared analog bus**, and **power-gated sensors**, you *definitely* want to combine **series resistors, RC filtering, and a pull-down** in a clean, well-defined way.

Below is a **correct, low-power, low-noise analog front end** that works well with nRF54L15 ADC and your TMR sensors.

---

## Recommended combined topology (this is the answer)

### **Place ALL of this at the MCU side (ADC pin)**

```
TMR1 OUT â”€â”€100â€“330Î©â”€â”€â”
TMR2 OUT â”€â”€100â€“330Î©â”€â”€â”¤
...                  â”œâ”€â”€ Analog bus â”€â”€ Rf â”€â”€â”¬â”€â”€ ADC (nRF54L15)
TMR9 OUT â”€â”€100â€“330Î©â”€â”€â”˜                        |
                                             |
                                           Cf (to GND)
                                             |
                                             |
                                           Rpd (to GND)
```

(gemini does not suggest 100R resistor, just the Rf. see later)
---

## Component values (proven, safe choices)

### 1ï¸âƒ£ Per-sensor series resistors (near each sensor)

**100â€“330 Î©** (100 Î© typical)

Purpose:

* Prevent output contention if timing overlaps
* Dampen ringing on long traces
* Protect sensor output drivers

---

### 2ï¸âƒ£ RC filter at MCU (critical for 30 cm traces)

**Rf (series resistor):**

* **330 Î© â€“ 1 kÎ©**
* Recommended: **680 Î©**

**Cf (shunt capacitor):**

* **220 pF â€“ 1 nF**
* Recommended: **470 pF**

This gives:
[
f_c = \frac{1}{2Ï€ R C}
]

For 680 Î© + 470 pF:
[
f_c â‰ˆ 500 kHz
]

âœ” Filters RF pickup
âœ” Stabilizes ADC sampling capacitor
âœ” Reduces kickback into sensors

---

### 3ï¸âƒ£ Pull-down resistor (for bus stability)

**Rpd:**

* **4.7 MÎ©** (recommended)
* Range: **1â€“10 MÎ©**

Purpose:

* Defines voltage when all sensors are OFF
* Prevents floating ADC input
* Avoids back-powering unpowered sensors

---

## Why this works (important)

### When all sensors are OFF

* Rpd pulls ADC cleanly to 0 V
* ADC input is stable
* No noise, no random readings

---

### When one sensor is ON

* Sensor output impedance â‰ª MÎ©
* Pull-down causes **negligible loading**
* RC does not distort DC value
* Signal settles well within your 100 Âµs window

---

### With 30 cm traces

* Long trace â‰ˆ antenna
* Series resistors + Cf kill ringing
* Rpd prevents charge accumulation

This is **exactly** how low-power industrial sensor buses are done.

---

## ADC timing check (important with RC)

Worst-case source impedance seen by ADC:

* Rf = 680 Î©
* Series sensor resistor = 100 Î©
* Total â‰ˆ **780 Î©**

This is **very low** for ADC acquisition.
You can safely use **short ADC acquisition times**.

Even with Cf = 470 pF:

* Settling to <Â½ LSB is well under **1 Âµs**

âœ” Fully compatible with your 100 Âµs ON window

---

## Where NOT to put things (common mistakes)

âŒ RC at the sensor
âŒ Pull-down at each sensor
âŒ Large capacitor (â‰¥10 nF) at ADC
âŒ Internal MCU pull-ups/pull-downs

All conditioning belongs **at the MCU**.

---

## Final â€œgoldenâ€ component set

| Part                | Value  | Location           |
| ------------------- | ------ | ------------------ |
| Series (per sensor) | 100 Î©  | Near sensor output |
| Rf                  | 680 Î©  | MCU side           |
| Cf                  | 470 pF | MCU side           |
| Rpd                 | 4.7 MÎ© | MCU side           |

---
gemini values:


The correct placement is to put the pull-down resistor **between the series filter resistor and the $\text{MCU}$'s $\text{AIN}$ pin.**

### Final $\text{RC}$ Filter and Pull-Down Topology

Here is the correct arrangement for your shared analog line ($\text{AIN}_{\text{SHARED}}$):

| Component | Location | Value (Example) | Purpose |
| :--- | :--- | :--- | :--- |
| **R$_{\text{filter}}$ (Series)** | Placed first, between the combined $\text{TMR}$ outputs and the rest of the circuit. | $1 \text{ k}\Omega$ | Forms the $\text{RC}$ low-pass filter to attenuate noise. |
| **C$_{\text{filter}}$ (Shunt)** | Placed between the series resistor and $\text{GND}$. This is the *node* connected to the $\text{MCU}$ $\text{AIN}$ pin. | $10 \text{ nF}$ | Filters high-frequency noise and stabilizes the $\text{ADC}$/$\text{LPCOMP}$ input voltage. |
| **R$_{\text{pull-down}}$** | Placed between the series resistor and $\text{GND}$, **in parallel** with $\text{C}_{\text{filter}}$, directly at the $\text{MCU}$ pin. | $100 \text{ k}\Omega$ | Ensures the $\text{MCU}$ pin is pulled to a stable $0 \text{ V}$ when the $\text{TMR}$ sensors are $\text{OFF}$. |

Q: do i need 1 series resistor per tmr output

That is a very insightful question, and the answer is **No, you do not need 1 series resistor per TMR output** in your current $9 \times 1$ multiplexed design. You only need **one single series resistor** on the shared analog line.

Here's why your current strategyâ€”placing the $\text{RC}$ filter and pull-down only on the shared lineâ€”is superior and sufficient:

### 1. The Power-Gating Advantage

The fundamental reason you don't need a resistor on each of the 9 TMR outputs is the power-gating strategy:

* **Only One Sensor is ON:** Since you only power $\text{ON}$ one TMR sensor (or one bank) at a time, only one sensor's output is actively driving the shared $\text{AIN}$ line.
* **Other Outputs are Silent:** The other 8 sensors' outputs are high-impedance (floating) because they are powered $\text{OFF}$. They are not injecting noise or signal into the shared line.

If you placed a series resistor on each output, it would create an unnecessary voltage divider and complicate the required filtering.

### 2. The Shared Filter is Most Effective

The purpose of the $\text{RC}$ filter is to clean the signal **right before it enters the $\text{MCU}$'s $\text{LPCOMP}$ and $\text{SAADC}$ peripherals.**

* **Source of Noise:** The main sources of noise are the switching events (when you power $\text{ON}$ the TMR bank) and general $\text{EMI}$ picked up along the shared trace.
* **Best Location:** Placing the single series resistor ($\text{R}_{\text{filter}}$) and capacitor ($\text{C}_{\text{filter}}$) right at the $\text{MCU}$ pin (the shared $\text{AIN}_{\text{SHARED}}$ node) filters **all** incoming signals effectively.

### 3. Comparison of Architectures

| Scenario | $\mathbf{9 \times 1}$ Shared Filter (Your Design) | $\mathbf{1}$ Series Resistor Per Output |
| :--- | :--- | :--- |
| **Components** | 1 $\text{R}_{\text{series}}$, 1 $\text{C}_{\text{shunt}}$, 1 $\text{R}_{\text{pull-down}}$ | 9 $\text{R}_{\text{series}}$, 1 $\text{C}_{\text{shunt}}$, 1 $\text{R}_{\text{pull-down}}$ |
| **Cost/Space** | Minimal. Best for $\text{PCB}$ area and cost. | Adds 8 extra components to the BOM. |
| **Performance** | Excellent. Filters noise right before the $\text{MCU}$ input. | Unnecessary. Adds complexity and potential variation if the 9 resistors aren't perfectly matched. |

**Conclusion:** Stick with the single series resistor ($\mathbf{1 \text{ k}\Omega}$) on the shared analog line, placed just before the pull-down resistor ($\mathbf{100 \text{ k}\Omega}$) and shunt capacitor ($\mathbf{10 \text{ nF}}$) which connect to your $\text{AIN}_{\text{SHARED}}$ pin. This is the optimal, most cost-effective, and cleanest solution for your power-gated, multiplexed design.

Q: (chatgpt) is 100R resistor needed per tmr?

Great question â€” and the answer is **no, you do *not* need multiple series resistors in series with each other**.
You need **one series resistor per sensor output**, *plus* (optionally) **one small series resistor at the MCU for the RC filter**. They serve different purposes.

Letâ€™s make this very clear.

---

## Short answer

* âœ… **Yes:** one **small series resistor per sensor** (near each sensor)
* âœ… **Yes (recommended):** one **RC series resistor at the MCU**

---

## Why there are two â€œtypesâ€ of series resistors

### 1ï¸âƒ£ Per-sensor series resistor (near sensor)

**Value:** 68â€“330 Î© (100 Î© typical)

**Purpose:**

* Prevents output contention if two sensors overlap briefly
* Limits fault/back-power current into unpowered sensors
* Damps ringing on long traces

**Think of this as â€œoutput protection.â€**

ğŸ“ **Place it close to each TMR sensor output pin.**

---

### 2ï¸âƒ£ MCU-side series resistor (part of RC filter)

**Value:** 330 Î© â€“ 1 kÎ© (680 Î© typical)

**Purpose:**

* Forms RC low-pass with Cf
* Isolates ADC sample-and-hold capacitor
* Reduces EMI pickup on 30 cm trace

**Think of this as â€œADC conditioning.â€**

ğŸ“ **Place it right at the MCU ADC pin.**

---

## Do these two resistors â€œadd upâ€?

Yes â€” but thatâ€™s **intentional and harmless**.

Example:

* Sensor resistor: 100 Î©
* MCU RC resistor: 680 Î©
* Total seen by ADC â‰ˆ **780 Î©**

That is:

* âœ” Very low for ADC input
* âœ” Far below any limit
* âœ” Settles in <<1 Âµs

So **no accuracy or speed problem**.

---

## Can you omit one of them?

### If you want to simplify:

#### Option A â€” Minimum safe design

* âœ” Keep **per-sensor 100 Î©**
* âœ” Keep **MCU RC resistor + capacitor**
  â¡ï¸ Best practice (recommended)

#### Option B â€” Fewer parts (acceptable if confident)

* âœ” Keep **only MCU RC resistor**
* âŒ Lose output contention protection
* âš ï¸ Risk if two sensors ever overlap ON

---

## Final recommendation for your design

Given:

* 9 sensors
* Shared analog bus
* 30 cm traces
* 100 Âµs sampling
* Battery-powered keyboard

ğŸ‘‰ **Keep both:**

* **100 Î© per sensor**
* **680 Î© + 470 pF at MCU**
* **4.7 MÎ© pull-down at MCU**

This is robust, low-power, and low-risk.

---

## Bottom line

* You donâ€™t â€œstackâ€ resistors unnecessarily
* Each resistor has a **different job**
* Total resistance stays small
* ADC performance remains excellent

---
---

Q: can a analog trace from a tmr sensor to ADC pin of nrf54 mcu be 35cm long?

This is a very long distance for a sensitive analog signal like the one from a
TMR (Tunnel Magnetoresistance) sensor, especially when connected directly to
the $\text{nRF54}$ MCU's ADC input on a standard PCB.The short answer is: It is
highly ill-advised for a high-performance system and will likely compromise the
accuracy and stability of your measurements. You should aim to keep sensitive
analog traces as short as possible, ideally under $5 \text{ cm}$.

Q: i am using TMR2617S-AAC sensor

That's excellent information. Knowing the specific sensor, the **TMR2617S-AAC**, allows us to define the precise requirements for your signal conditioning, confirming that the $35 \text{ cm}$ trace is a major problem and how best to solve it.

### Key Specs of the TMR2617S-AAC

The datasheet confirms three crucial points:

1.  **Integrated Amplification:** The TMR2617S-AAC **integrates a low-noise operational amplifier and DAC circuit** to provide an analog output voltage ($\text{V}_{\text{OUT}}$).
    * **Implication:** This is good news! The sensor's output is **already buffered**, meaning the signal impedance is low (it can drive a load resistance of $10 \text{ k}\Omega$ and $10 \text{ nF}$ load capacitance). This makes the signal much more robust than a raw $\text{TMR}$ Wheatstone bridge.
2.  **Output Voltage Range:** The output voltage follows the supply voltage ($\text{V}_{\text{CC}}$) and typically swings from **$5\%$ to $95\%$ of $\text{V}_{\text{CC}}$**.
    * **Implication:** This is a **rail-to-rail** type signal, perfectly suited for the $\text{nRF54}$'s $\text{ADC}$. If your $\text{V}_{\text{CC}}$ is $3.3 \text{ V}$, the signal ranges from $165 \text{ mV}$ to $3.135 \text{ V}$.
3.  **Noise:** The maximum noise specified is $10 \text{ mV}_{\text{PP}}$ (peak-to-peak) over a $5 \text{ kHz}$ bandwidth. This is the noise *at the sensor's output*.

### The $35 \text{ cm}$ Trace Problem Re-evaluated

Even with the sensor's low-impedance, buffered output, a $35 \text{ cm}$ trace on a PCB is still highly susceptible to **noise coupling (EMI/Crosstalk)**.

The long trace acts as a large antenna, and $35 \text{ cm}$ is too long to rely on the sensor's internal buffering alone, especially for a high-resolution $\text{ADC}$ on the $\text{nRF54}$. The $10 \text{ mV}_{\text{PP}}$ noise floor from the sensor could easily be overwhelmed by noise picked up over the trace.

### The Best Solution: Local Signal Cleanup and Isolation

Since the sensor is already buffered, you don't need a heavy-duty Op-Amp circuit, but you do need to clean and isolate the signal before it travels $35 \text{ cm}$.

The best approach involves:

| Step | Action | Benefit |
| :--- | :--- | :--- |
| **1. Local Decoupling** | Place a **decoupling capacitor** ($10 \text{ nF}$ to $100 \text{ nF}$) and a **ferrite bead or small inductor** on the $\text{V}_{\text{OUT}}$ pin immediately next to the TMR2617S-AAC. | Filters out high-frequency noise that the sensor's output might produce or pick up locally. |
| **2. Use Shielding/Guard Traces** | Route the $35 \text{ cm}$ signal trace on the top layer, but run a **Guard Trace** on either side of it, connected securely to ground (GND) at frequent intervals (vias every $5 \text{ mm}$). | The ground traces act as shielding to capacitively couple external noise away from the signal trace. This is crucial for a long run. |
| **3. Utilize a Star Topology for GND** | Ensure the $\text{TMR}$ sensor's local ground is connected robustly to the $\text{nRF54}$'s ground. A continuous, clean ground plane on the bottom layer is the best defense. | Minimizes ground loops and ground bounce noise. |
| **4. Add an $\text{RC}$ Low-Pass Filter at the $\text{ADC}$** | Place a simple $\text{RC}$ filter right before the $\text{nRF54}$'s $\text{ADC}$ pin. | Filters out any remaining high-frequency noise (especially digital spikes) picked up by the $35 \text{ cm}$ run, helping the $\text{ADC}$ acquire a clean sample. |

**Component Values for $\text{RC}$ Filter (Step 4):**

* Since the TMR2617S-AAC has a bandwidth ($\text{BW}$) of up to $50 \text{ kHz}$, you should target an $\text{RC}$ filter cutoff frequency ($\text{f}_{\text{c}}$) slightly above your desired measurement rate, but below $50 \text{ kHz}$ to filter out high-frequency noise.
* A common approach is $R = 100 \text{ } \Omega$ to $1 \text{ k}\Omega$ and $C = 1 \text{ nF}$ to $10 \text{ nF}$.
    * Example: $R = 1 \text{ k}\Omega$ and $C = 1 \text{ nF} \rightarrow f_c \approx 159 \text{ kHz}$. This is a good balance.

### ğŸ¯ Final Conclusion

The TMR2617S-AAC is much more robust than a raw $\text{TMR}$ bridge, but the $35 \text{ cm}$ run remains a **serious $\text{EMI}$ risk**.

You can make it work reliably only by implementing **strict $\text{PCB}$ layout techniques** including a strong ground plane, guard traces, and an $\text{RC}$ filter near the $\text{nRF54}$'s $\text{ADC}$ pin.


---
----
Q:
this is for a keyboard application. do i need to run ground traces on either side of sensor trace if there is already a ground plane underneath (2 layer pcb). also does the keyboard change RC filter values. show a circuit of RC filter at mcu pin

These are very important, practical PCB layout questions for your keyboard application. Since your PCB is a large, flat 2-layer board, the effectiveness of the ground plane and filtering are critical.

### 1. Ground Traces (Guarding) vs. Ground Plane

**Do I need to run ground traces on either side of the sensor trace if there is already a ground plane underneath (2 layer pcb)?**

**YES, you still should use guarding traces along the $35 \text{ cm}$ run, but they serve a different purpose than the ground plane.**

| Feature | Primary Purpose for $35 \text{ cm}$ Analog Trace |
| :--- | :--- |
| **Ground Plane (Bottom Layer)** | **Provides Return Path & Controls Impedance.** It defines the impedance of the trace and ensures the signal has a solid, continuous low-impedance path back to the MCU's ground. **This is mandatory.** |
| **Guard Traces (Top Layer, flanking the signal)** | **Provides Electrostatic Shielding (Isolation).** They protect the signal trace from **capacitive coupling** from adjacent *top-layer* digital traces that might run in parallel (crosstalk). They also help stabilize the signal path. |

#### **Why Guarding is Necessary on the Top Layer:**

* **Top-Layer Crosstalk:** On the top layer (where your $35 \text{ cm}$ analog trace is), you will inevitably have digital traces for LEDs, matrix scanning, and $\text{USB}$/$\text{BLE}$ lines running parallel. These digital lines couple noise onto the analog trace primarily via **electric field (capacitive) coupling**.
* **How Guarding Works:** The guard traces are connected frequently to the ground plane with **vias** (e.g., every $5 \text{ mm}$ to $1 \text{ cm}$). When a digital line's electric field tries to couple onto your analog trace, the field is instead terminated by the adjacent ground trace, effectively shielding the sensitive signal.

**Conclusion:** For a very long run like $35 \text{ cm}$, the ground plane handles the return path, and the top-layer guard traces handle the isolation from top-layer noise. You need both for reliable $\text{ADC}$ readings.

---

### 2. $\text{RC}$ Filter Values and the Keyboard Application

**Does the keyboard application change $\text{RC}$ filter values?**

**YES, indirectly.** The main factor is **how fast** the keyboard needs to measure the $\text{TMR}$ sensor.

* The $\text{RC}$ filter's job is to create a **Low-Pass Filter ($\text{LPF}$)** to remove high-frequency noise picked up by the $35 \text{ cm}$ trace, while allowing your intended signal frequency to pass through cleanly.

* **TMR Sensor Frequency:** The TMR2617S-AAC has an internal bandwidth ($\text{BW}$) of up to $50 \text{ kHz}$. You only need to measure this sensor at the rate required by your application (e.g., $10 \text{ Hz}$ to $100 \text{ Hz}$ to detect key actuation or position).

* **Keyboard Impact:** Since the required measurement rate for a keyboard is very slow, you can use a very low cutoff frequency ($\text{f}_{\text{c}}$) for your $\text{RC}$ filter, which provides maximum noise rejection.

#### **Recommended Filter Design for Low Frequency Keyboard Sampling**

Target a cutoff frequency ($\text{f}_{\text{c}}$) in the range of **$1 \text{ kHz}$ to $10 \text{ kHz}$**. This will reject almost all of the unwanted $\text{EMI}$ noise ($\text{MHz}$ range) and high-frequency digital crosstalk, while easily passing your slow $\text{TMR}$ signal changes.

The $\text{RC}$ cutoff frequency is calculated as:
$$f_c = \frac{1}{2\pi R C}$$

| Component Values | Resulting $\text{f}_{\text{c}}$ | Notes |
| :--- | :--- | :--- |
| **$R = 10 \text{ k}\Omega$** | $\approx 1.59 \text{ kHz}$ | Provides maximum noise rejection while keeping sampling artifacts low. Excellent for slow, high-accuracy sensing. |
| **$C = 10 \text{ nF}$** | $\approx 15.9 \text{ kHz}$ | A slightly faster cutoff if you need a faster response time. |
| **$R = 1 \text{ k}\Omega$** | **$\approx 15.9 \text{ kHz}$** | Standard practice for $\text{ADC}$ pins; a safe, general-purpose choice. |

**Important Note on Resistance (R):** For the $\text{nRF54}$'s $\text{ADC}$ accuracy, the series resistance ($\text{R}$) should generally be kept below a few $\text{k}\Omega$ to allow the internal sampling capacitor to fully charge between $\text{ADC}$ conversions. $R = 1 \text{ k}\Omega$ is a safe limit.

---

### 3. $\text{RC}$ Filter Circuit at the $\text{MCU}$ Pin

Here is the simple $\text{RC}$ circuit you should place directly at the $\text{nRF54L15}$ $\text{ADC}$ input pin.

The components should be located right next to the $\text{nRF54}$ package, minimizing the trace between the capacitor's ground and the $\text{MCU}$'s ground pin.

$$
\text{Analog Signal} \rightarrow R \rightarrow \text{ADC Pin} \\
\qquad\qquad\qquad\quad\downarrow \\
\qquad\qquad\qquad\quad C \\
\qquad\qquad\qquad\quad\downarrow \\
\qquad\qquad\qquad\quad \text{GND}
$$



**Circuit Description:**

* **$\text{R}_{\text{FILTER}}$:** The resistor is placed **in series** with the signal line. It forms the resistance part of the low-pass filter and isolates the long, noisy trace from the $\text{ADC}$ input.
* **$\text{C}_{\text{FILTER}}$:** The capacitor is placed from the line (after the resistor) to **local ground ($\text{GND}$)**. It shunts high-frequency noise to ground.

Would you like advice on how to use the $\text{nRF54L15}$'s $\text{ADC}$ configuration (oversampling, gain) to further improve noise immunity once you have this clean signal?

Q: yes

That is the perfect final step! Once the signal is physically cleaned up by the $\text{RC}$ filter and PCB layout, you can leverage the $\text{nRF54L15}$'s advanced $\text{ADC}$ features to maximize accuracy and minimize the influence of remaining random noise.

The key features to use are **Resolution/Gain** and **Oversampling**.

---

## 1. ADC Resolution and Gain Configuration

The $\text{nRF54L15}$'s $\text{ADC}$ is a significant upgrade, capable of up to **14-bit resolution** (at lower sampling rates), compared to the 12-bit $\text{ADC}$ on the $\text{nRF52}$ series. You should configure it to utilize this higher resolution.

### A. Resolution (Higher is Better)

* **Setting:** Set the $\text{ADC}$ resolution to **14-bit** (default is often 10-bit or 12-bit).
* **Benefit:** 14-bit resolution provides $2^{14} = 16,384$ distinct measurement levels across the reference voltage range, giving you four times the precision of a 12-bit $\text{ADC}$.

### B. Gain (Maximizing the Signal Window)

The $\text{ADC}$ measures the input voltage relative to an internal $\text{Reference Voltage}$ ($\text{V}_{\text{REF}}$), which is typically $\approx 0.9 \text{ V}$ (Internal Reference). The gain determines how the input voltage is scaled relative to this reference.

| TMR Output $\text{V}_{\text{RANGE}}$ | Desired $\text{V}_{\text{REF}}$ Setting | $\text{ADC}$ Gain Setting (Example) | Notes |
| :--- | :--- | :--- | :--- |
| $\approx 0.165 \text{ V}$ to $\mathbf{3.135 \text{ V}}$ ($\mathbf{3.3 \text{ V}}$ $\text{V}_{\text{CC}}$) | Full Scale ($\text{V}_{\text{CC}}$ or External $\text{V}_{\text{REF}}$) | **$\text{ADC}_{\text{GAIN}} = 1/4$** | Since your signal swings almost rail-to-rail ($\approx 3.3 \text{ V}$), you must use a fractional gain to **attenuate** the input voltage so that the maximum signal ($\approx 3.135 \text{ V}$) is within the $\text{ADC}$'s internal reference range ($\approx 0.9 \text{ V}$). |
| **Calculation Example:** | If $\text{V}_{\text{REF}}=0.9 \text{ V}$ and you set **$\text{Gain}=1/4$**, the maximum measurable input voltage is $0.9 \text{ V} \times 4 = 3.6 \text{ V}$. This safely covers your $3.3 \text{ V}$ signal range. | **Crucial:** Using the wrong gain (e.g., $\text{Gain}=1$) will cause the $\text{ADC}$ to "clip" the signal at $\approx 0.9 \text{ V}$. |

---

## 2. Oversampling (The Firmware Noise Reduction)

Oversampling is a highly effective, low-power technique implemented in hardware and/or software to reduce random noise in the final reading.

### The Principle

By taking $N$ samples very quickly and averaging them, the random noise components (which are uncorrelated) tend to cancel out. The theoretical $\text{Signal-to-Noise Ratio}$ ($\text{SNR}$) improvement is proportional to $\sqrt{\text{Oversampling Ratio (OSR)}}$.

$$\text{Resolution Gain (bits)} = \frac{1}{2} \times \log_2(\text{OSR})$$

* **OSR = 4:** You gain $\frac{1}{2} \times \log_2(4) = 1$ additional bit of resolution.
* **OSR = 16:** You gain $\frac{1}{2} \times \log_2(16) = 2$ additional bits of resolution.

### $\text{nRF54L15}$ Implementation

The $\text{nRF54L15}$'s $\text{ADC}$ supports built-in hardware oversampling, which is preferred for power efficiency.

| Oversampling Setting ($\text{OSR}$) | $\text{Resolution Gain}$ | Effective Resolution (Starting at 14-bit) | Notes |
| :--- | :--- | :--- | :--- |
| **$2\times$** | $0.5$ bits | $14.5$ bits | Requires minimal extra power/time. |
| **$4\times$** | $1.0$ bits | **$15.0$ bits** | A good balance for reducing noise. |
| **$16\times$** | $2.0$ bits | **$16.0$ bits** | Ideal for maximum noise reduction if the measurement rate is very low (e.g., $10 \text{ Hz}$). |

**Recommendation:**

1.  Set the hardware resolution to **14-bit**.
2.  Enable hardware **$4\times$ or $16\times$ oversampling** to gain an effective resolution of $15$ to $16$ bits. This leverages the noise (dithering) that is inevitably present to get a much cleaner, more stable reading.

This combination of a clean input signal (from the $\text{RC}$ filter) and optimized $\text{ADC}$ configuration (14-bit resolution, proper gain, and oversampling) will give you the most accurate and stable TMR readings possible on the $\text{nRF54L15}$.

----
----

Q: going back to the question of BLE antennae connecting to nrf mcu on a 2 layer board, if i place the antennae very close to the mcu, is it OK to use a 2 layer pcb

Yes, if you place the antenna **very close** to the nRF54L15 MCU, using a **2-layer PCB is perfectly acceptable and is the standard industry practice** for cost-sensitive, high-volume products like keyboards and mice.

### Why Proximity Makes a 2-Layer Board Viable

The critical issue with the 2-layer board is controlling the **$50 \text{ } \Omega$ transmission line impedance**. When the antenna is placed close to the MCU, you drastically simplify this challenge:

#### 1. Trace Length is Minimized (The Key Factor)

* **The Goal:** The total length of the RF trace, from the nRF's output pin, through the matching network, to the antenna feed point, should be minimized, ideally **under $10 \text{ mm}$ (and preferably under $5 \text{ mm}$)**.
* **The Benefit:** Over such a short distance, the effect of impedance mismatch and signal loss is negligible. Even if the trace is not a **perfect $50 \text{ } \Omega$ transmission line** (which is hard to achieve on a 2-layer board), the short length means power loss is minimal, and the matching network can easily compensate for any slight imperfections.

#### 2. The Ground Plane Requirement is Still Critical

While you are using a 2-layer board, you must dedicate the entire bottom layer to a solid, unbroken **Ground Plane** beneath the RF components and their short traces.

| Component | Layer | Requirement |
| :--- | :--- | :--- |
| **nRF54L15** | Top | Must have a continuous ground plane underneath on the bottom layer. |
| **Matching Network** | Top | Components (inductors/capacitors) must be placed directly between the $\text{nRF}$ pin and the antenna feed point. |
| **RF Trace** | Top | Must run directly above the solid ground plane on the bottom layer. |
| **Antenna (e.g., MIFA)** | Top | Requires a **large ground plane cutout** (Keep-out Area) directly beneath it on the bottom layer for the antenna to radiate correctly.  |

### 3. Tuning is Mandatory

Regardless of how close the antenna is placed, you must remember that a PCB trace antenna is highly sensitive to its environment (the plastic enclosure, battery, nearby metal parts).

* **Matching Network (L-C):** You must include a set of passive components (L-C matching network) near the antenna feed point.
* **Process:** During prototyping, you use a Vector Network Analyzer ($\text{VNA}$) to tune these L-C values until the return loss is acceptable ($S_{11}$ less than $-10 \text{ dB}$ at $2.44 \text{ GHz}$).

**In summary, using a 2-layer PCB is fine for your BLE keyboard, provided you adhere strictly to the following golden rules of RF layout:**

1.  **Place the nRF and Antenna as Close as Possible.**
2.  **Use a Solid Ground Plane** on the bottom layer.
3.  **Implement the Mandatory Antenna Keep-Out Area** (no copper under the antenna on any layer).
4.  **Include and Tune the Matching Network** in the final enclosure.

Would you like to know the typical range performance difference you might expect between an optimally tuned PCB trace antenna and a high-performance ceramic chip antenna in a keyboard setting?

Q:
in this case i can minimize analog trace length from tmr sensor to 130mm. do i still need RC circuit next to mcu pin, if i am using the 'sense' pins to detect crossing a certain voltage.

That is a great clarification. Reducing the trace length to $130 \text{ mm}$ significantly improves things, and using the **Sense** feature instead of the $\text{ADC}$ fundamentally changes the required signal conditioning.

### Short Answer: You still need the $\text{RC}$ circuit, but for a different reason.

Even at $130 \text{ mm}$, the trace is long enough to pick up significant noise. The $\text{RC}$ filter is now less about $ADC$ acquisition time and more about **preventing false triggers** (chattering) on the $\text{Sense}$ pin.

Here is why:

### 1. The Challenge: Digital Thresholds on an Analog Signal

The GPIO Sense mechanism on the nRF54L15 works by comparing the input voltage ($\text{V}_{\text{IN}}$) to fixed digital thresholds ($\text{V}_{\text{IH}}$ for Sense High, $\text{V}_{\text{IL}}$ for Sense Low).

* **Logic High Threshold ($\text{V}_{\text{IH}}$):** For $\text{VDD}=3.3 \text{ V}$, this is $\mathbf{0.7 \times \text{VDD}}$, or $\approx \mathbf{2.31 \text{ V}}$.
* **Logic Low Threshold ($\text{V}_{\text{IL}}$):** For $\text{VDD}=3.3 \text{ V}$, this is $\mathbf{0.3 \times \text{VDD}}$, or $\approx \mathbf{0.99 \text{ V}}$.

Your TMR sensor's output (which is an analog signal ranging from $\approx 0.165 \text{ V}$ to $\approx 3.135 \text{ V}$) will cross these thresholds when the magnetic field changes.

#### The Noise Problem (False Triggers)

A $130 \text{ mm}$ trace will inevitably pick up high-frequency digital noise ($\text{EMI}$ spikes) from the keyboard's scanning lines and the $\text{nRF}$'s internal switching.

1.  **Noise Peak:** If the TMR signal is *just* below the $\text{V}_{\text{IH}}$ sense threshold (e.g., $2.30 \text{ V}$), a momentary noise spike of just $20 \text{ mV}$ could push the signal over $2.31 \text{ V}$.
2.  **False Trigger:** This noise spike would cause the GPIO Sense to briefly trigger a $\text{DETECT}$ event, waking the $\text{CPU}$ prematurely.
3.  **Chattering:** If the signal hovers near the threshold, the noise will repeatedly cross the boundary, leading to continuous false $\text{DETECT}$ events (chattering).

### 2. The Solution: The $\text{RC}$ Filter as a Noise Trap

The $\text{RC}$ filter, placed right at the $\text{MCU}$ pin, acts as a **low-pass filter ($\text{LPF}$)** that smooths out these high-frequency noise spikes **without affecting your slow magnetic change signal.**

* The goal is not to improve $\text{ADC}$ resolution, but to create a cleaner, more stable signal for the digital sense comparator.

#### **Hysteresis (A Natural Defense)**

Note that the $\text{nRF54L15}$ GPIO input buffers do have a small amount of **hysteresis** built in (the high-going threshold is slightly different from the low-going threshold) to combat this chattering, but it is often not enough to handle a long, noisy trace. The $\text{RC}$ filter provides extra insurance.

### 3. Recommended $\text{RC}$ Filter Values

Since your application only needs to detect a slow change (a key press), you can use a very aggressive filter to eliminate noise completely.

| Component | Value | Rationale |
| :--- | :--- | :--- |
| **Resistor ($\text{R}$)** | $\mathbf{1 \text{ k}\Omega}$ | Limits current for pin safety and forms the filter. Should be kept low enough to charge the pin's tiny input capacitance quickly. |
| **Capacitor ($\text{C}$)** | $\mathbf{10 \text{ nF}}$ | Provides excellent filtering for high-frequency noise. |
| **Cutoff Frequency ($\mathbf{f_c}$)** | $\approx 15.9 \text{ kHz}$ | This low cutoff frequency ensures all $\text{MHz}$ range noise (from the digital system) is attenuated by $99\%$ or more, preventing false $\text{Sense}$ triggers. |

**Final Conclusion:**

Yes, you should **definitely use the $\text{RC}$ circuit** on the $\mathbf{130 \text{ mm}}$ analog trace before the $\text{nRF54}$ GPIO $\text{Sense}$ pin. Its purpose is to filter out high-frequency noise that would otherwise cause false key presses and drain your battery by waking the $\text{MCU}$ unnecessarily.

----
---
