Based on your usage requirements, the **maximum average power** the LED matrix can draw during active use is approximately **$232 \text{ mW}$** (or $62.7 \text{ mA}$ average current).

This calculation assumes a nominal battery voltage of **$3.7\text{V}$** (typical for Li-ion/Li-Po) and accounts for the power consumed by the microcontroller and LED driver chip.

---

## 1. Required Active Current Calculation

The $4000 \text{mAh}$ battery must supply all the current needed for one week, with $56$ hours of active use. We assume the system is in deep sleep for the remaining time, making the sleep current negligible.

| Parameter | Value | Calculation |
| :--- | :--- | :--- |
| **Total Active Usage Time** | $56 \text{ hours}$ | $7 \text{ days} \times 8 \text{ hours/day}$ |
| **Max Total Active Current** | $\approx 71.43 \text{ mA}$ | $\frac{4000 \text{ mAh}}{56 \text{ h}}$ |
| **Estimated System Overhead** | $\approx 8.77 \text{ mA}$ | Current for MCU (nRF52840, $\approx 6.6 \text{ mA}$) + LED Driver (IS31FL3731 quiescent, $\approx 2.17 \text{ mA}$) |
| **Max Average LED Matrix Current** | **$\approx 62.66 \text{ mA}$** | $71.43 \text{ mA} - 8.77 \text{ mA}$ |

---

## 2. Maximum Average LED Matrix Power

Using the calculated maximum current and the battery's nominal voltage ($\text{V}_{\text{batt}}=3.7\text{V}$):

$$\text{P}_{\text{max}} = \text{I}_{\text{LED\_max}} \times \text{V}_{\text{batt}}$$
$$\text{P}_{\text{max}} = 62.66 \text{ mA} \times 3.7\text{V} \approx 231.84 \text{ mW}$$

Therefore, the maximum power the LED matrix can draw is **$231.84 \text{ mW}$** on average during your 8 hours of daily use.

---

## Practical Implication for Brightness

To put the $\mathbf{62.66 \text{ mA}}$ maximum average current into context using the **IS31FL3731** driver (as discussed previously, which drives a $16 \times 9$ matrix with 144 LEDs):

* The IS31FL3731 draws $\approx 180 \text{ mA}$ when all 144 LEDs are driven at their **maximum average brightness** (assuming a $20 \text{k}\Omega$ external resistor).

Since your allowed current ($62.66 \text{ mA}$) is significantly **lower** than the maximum possible draw ($180 \text{ mA}$), you would have to **limit the brightness** of your LED matrix to maintain the week-long battery life.

$$\text{Max Brightness Percentage} \approx \frac{62.66 \text{ mA}}{180 \text{ mA}} \approx 34.8\%$$

You would need to set the software dimming register to a level equivalent to about **$35\%$** of the maximum possible brightness for the whole matrix to last a week.

---
---

Here are the **typical real-world current-draw numbers** for an **nRF52840 running ZMK**, based on common keyboard PCB designs (nice!nano v2, ZMK power-profiles, etc.):

---

## âœ… **Normal Current Draw for nRF52840 in ZMK**

These are *typical* values when the board is configured correctly (deep sleep, no OLED, no extra sensors):

### **Idle (deep sleep / standby)**

* **8â€“15 ÂµA** for a fully optimized ZMK build
* **20â€“40 ÂµA** is common on real boards with regulators, power rails, etc.
* A poorly designed PCB or ESD chips may raise this into the **80â€“200 ÂµA** range.

### **Advertising (BLE not connected)**

* **150â€“450 ÂµA average**, depending on:

  * Advertising interval
  * TX power setting
  * Board hardware setup

### **Connected (normal operation)**

* **90â€“300 ÂµA average** with:

  * Standard ZMK BLE connection interval
  * No heavy peripherals
  * Keyboard idle (no keypresses)

### **Active typing**

* **1â€“3 mA** momentary peaks
* Very briefâ€”average over time stays low.

### **Absolute peak events**

* **5â€“8 mA** radio TX spike
* Only milliseconds long
* Doesnâ€™t significantly affect average battery life.

---

## ðŸ”§ Factors that increase current draw

* OLED screens (20â€“30 mA)
* RGB underglow/LEDs (10â€“80+ mA depending on count)
* Poor regulator quiescent current (15â€“200+ ÂµA depending on PCB)
* Incorrect ZMK power settings
* Sensors (PMW3360, battery gauge chips, etc.)

---

## ðŸŽ¯ What ZMK users usually observe

For **nice!nano v2 running ZMK**, users typically report:

* **25â€“35 ÂµA idle**
* **150â€“250 ÂµA connected idle**
* **1â€“3 mA during typing bursts**

Which matches the expected behavior for the nRF52840.

---

If you want, I can help you:

* Measure your boardâ€™s actual draw
* Compare against expected values
* Optimize your ZMK config for lower power

Just tell me your board (nice!nano, custom PCB, etc.).

---

Can use TSX339 (5nA current, need 18)

or find a TI comparator here:
https://www.ti.com/product-category/amplifiers/comparators/products.html#p1typ=0.001;0.01

for nRF52840 to work efficiently, it has to sleep and be waken up every time a
key is typed (when gpio pin goes high). use a comparator for each switch
(preferably drawing <5uA), adjust the threshold using a variable volt
programmable device (not `researched yet), connect digital output of switches
in a matrix. All of this more complicated than just using ADC expanders and rp2040.

less efficient solution is to use a analog mux (they're low power) and do all
adc inside nRF52840.

----

