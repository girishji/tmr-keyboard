Where to connect the power?
You should connect the VCC of the LED driver to the Li-Po battery ($V_{BATT}$),
not the regulated 2.1V or 3.0V output of the nPM1100.

Use is31fl3731

For a battery-powered magnetic keyboard with 72 LEDs, you should use a dedicated ** LED Matrix Driver**, and you should power it **directly from the Li-Po battery** (not through the nPM1100).

Here is the reasoning for this hardware architecture.

### 1. Recommended IC: IS31FL3731 (or IS31FL3733)

* **Logic Compatibility:** It works with **1.8V - 3.3V logic**, so your **2.1V nRF54L15** can talk to it directly over  without level shifters.
* **Constant Current:** It has internal current sinks. You **do not need resistors** for each LED. This saves huge amounts of PCB space and assembly cost.
* **No "Flash" Noise:** It uses a scanning matrix, meaning it only turns on a few LEDs at any exact microsecond. This eliminates the massive 72mA current spikes that would otherwise interfere with your **TMR2617 sensors**.

---

### 2. Where to connect the power?

You should connect the **VCC of the LED driver to the Li-Po battery** (), not the regulated 2.1V or 3.0V output of the nPM1100.

| Feature | Powered by nPM1100 (Buck) | Powered by Li-Po (Direct) |
| --- | --- | --- |
| **Efficiency** | Lower (Double conversion loss) | **Higher (Single conversion)** |
| **TMR Noise** | **Bad** (LED noise leaks into TMR rail) | **Great** (LED noise is isolated on the battery) |
| **Brightness** | Limited by 2.1V/3.0V rail | **Consistent** (Driver regulates current internally) |

**Why this is better:**
The nPM1100 buck converter has a maximum current limit. If you try to pull 72mA for LEDs + MCU current + Sensor current through it, you might hit the "current limit" and cause the whole system to reset. By powering the LED driver from the battery, the driver handles the voltage swings of the battery ( to ) and keeps the LED brightness **perfectly constant** regardless of battery level.

---

### 3. Comparison of Architectures

| Feature | Your MOSFET Setup |  Matrix Driver Setup |
| --- | --- | --- |
| **Components** | 1 MOSFET + 72 Resistors | **1 IC + 0 Resistors** |
| **Wiring** | 72 traces to resistors | **18 traces (Matrix)** |
| **TMR Accuracy** | Risky (PWM Noise) | **High (Silent operation)** |
| **Individual Control** | No (All or none) | **Yes (Per-key lighting/animations)** |

### Summary Recommendation

1. **Power:** Keep the **nPM1100 at 3.0V** to power the nRF54L15 and the TMR2617 sensors (for best resolution).
2. **LEDs:** Use the **IS31FL3733** or **IS31FL3731**. Connect its power pin directly to the **Li-Po battery**.
3. **Control:** Connect the  pins (SDA/SCL) to your nRF54L15.

This setup ensures that your magnetic sensors are in a "quiet" electrical environment, your battery lasts significantly longer, and you gain the ability to do cool per-key RGB or white lighting effects later.

---
---


Q:
i have 72 led's ON simultaneously (one per key). power saving is important. how does PWM save power? same amount of power need to be spent to get the same brightness , no?


It is a common misconception that PWM and DC "spend" the same power for the same brightness. In reality, **PWM is significantly more efficient for battery life** because of how the human eye works.

Here is why PWM saves power in your keyboard design, especially with 72 LEDs:

### 1. The "Persistence of Vision" Effect

Your brain doesn't see a "dim" LED; it sees a **bright** LED that was just there a millisecond ago.

When you use PWM, you flash the LED at full current (e.g., 5mA) for a tiny fraction of time (e.g., 10% duty cycle).

* **The LED:** Only uses 10% of the energy.
* **The Eye:** Because of the high peak brightness, your brain "remembers" the peak and perceives the LED as much brighter than a DC-dimmed LED using that same 10% energy.

> **The Math:** To get a certain "comfortable" brightness, you might only need a **2% duty cycle** with PWM, whereas achieving that same perceived brightness with DC would require a constant current that consumes significantly more total battery power.

---

### 2. Efficiency: Resistor Waste vs. Buck Converter

This is the most important part of your **nPM1100 + 3.0V** setup:

* **In DC (Static):** To dim the LEDs to  at , you have to use a large  resistor. That resistor is constantly burning off energy as heat.
* **In PWM:** You use a much smaller resistor (sized for, say,  or ). When the LED is **ON**, it is efficient because the "overhead" of the resistor is lower relative to the light produced. When the LED is **OFF**, it consumes **zero** power.

Because your **nPM1100 is a Buck converter**, it is "smart." When the LEDs are in the "OFF" phase of the PWM cycle, the nPM1100 actually draws almost zero current from your battery.

---

### 3. LED Color Stability

If you try to save power by simply lowering the voltage (DC dimming) to the point where the LEDs are very dim, green LEDs often shift toward a "sickly" yellowish hue.

* **PWM** keeps the LED at its "true" forward voltage () when it's on, ensuring your keyboard looks high-end with consistent, crisp green light across all keys.

---

---
---

q: wont is31fl3731 itself waste power ? compare to using PWM from mcu


### 3. Noise & Signal Integrity (Your Keyboard's Performance)

Beyond just power, the IS31FL3731 protects your **TMR2617 sensors**.

* **The MOSFET Method:** When your MOSFET slams 72 LEDs "ON," it creates a massive EMI (Electro-Magnetic Interference) spike. Because you are building a **magnetic keyboard**, these spikes can interfere with your TMR sensors' ability to detect the magnet's position accurately.
* **The Driver Method:** The IS31FL3731 "scans" the LEDs. It turns on one group, then the next, very fast (). The current draw is steady and "quiet," which keeps your analog sensor readings clean.

---
----
---


PWM Noise: Switching $36\text{mA}$ at high frequency (PWM) can create
electrical noise on the $2.1\text{V}$ rail. This might "jitter" your TMR sensor
readings.Solution: Place a large $10\mu\text{F}$ Ceramic Capacitor directly at
the "Power" side of your LED bank to act as a buffer for the PWM pulses.
(grok says dont do above)

MOSFET: Use the Si2302ADS (or similar N-channel) as discussed. It will handle the $36\text{mA}$ PWM with effectively zero voltage drop.

PWM Frequency: Set your nRF54L15 PWM to at least $200\text{Hz}$ to avoid human-eye flicker. $1\text{kHz}$ is usually the "sweet spot" for indicators. If TMR noise is seen increase freq to 2-4khz

Series Resistor ($R_G$): $100\Omega$ to $470\Omega$.Recommendation: $220\Omega$
is a perfect middle ground. It's high enough to protect the pin but low enough
that the MOSFET still switches fast.

Gate Resistor: Don't forget a $10\text{k}\Omega$ pull-down on the MOSFET gate
so the LEDs don't flash when the nRF54 is in reset or sleep mode.
Pull-down Resistor ($R_{GS}$): $10\text{k}\Omega$ to $100\text{k}\Omega$.This
goes from the Gate to Ground. It ensures the MOSFET stays OFF while the MCU is
booting up or if the pin is accidentally set to an input state.

Where to place them in KiCadSeries Resistor: Place it as close to the MCU pin
as possible.Pull-down Resistor: Place it after the series resistor, close to
the MOSFET Gate.

Does it affect the PWM?Since you are likely PWM-ing at $1\text{kHz}$ or
$2\text{kHz}$ to dim the LEDs, a $220\Omega$ resistor will have zero noticeable
effect on the dimming performance. The "slowdown" it causes is in the
nanosecond range, which is much faster than the PWM frequency.

---


Q : Which color is best

If you are looking for the lowest power consumption at 3V, **Red** is your best
choice, though **Green** is often the winner if you care about how much light
you actually see.

The power an LED consumes is the product of its **Forward Voltage** (V_f) and
the **Current** (I) flowing through it (P = V \times I).

###1. The Lowest "Physical" Power: REDRed LEDs have the lowest forward voltage,
typically between **1.8V and 2.2V**.

* **Why it consumes less:** Because its "threshold" to turn on is so low, you
* can run it at a very low current and it will still glow. **3V
* Compatibility:** At 3V, a Red LED is well above its turn-on point. You
* **must** use a resistor (around 100\Omega to 470\Omega) to limit the current,
* or it will draw too much power and burn out. **The Math:** If you aim for a
* dim but visible indicator at 2mA: **Red:** 1.8\text{V} \times 0.002\text{A} =
* 0.0036\text{W} (3.6mW) **Blue/White:** 3.0\text{V} \times 0.002\text{A} =
* 0.006\text{W} (6.0mW)



###2. The Lowest "Perceived" Power: GREENWhile Red uses the least raw
electricity, the human eye is most sensitive to **Green** light.

* **Efficiency:** Because your eyes are so good at seeing green, you can run a
* Green LED at a tiny fraction of the current (e.g., 0.5\text{mA}) and it will
* appear just as bright as a Red LED running at 5\text{mA}. **Note on Types:**
* "Standard" Green LEDs (yellowish-green) have a low voltage (2.1\text{V}),
* while "True Green" or "Emerald" LEDs have a higher voltage (3.2\text{V}). For
* a 3V battery, the **Standard Green** is the most power-efficient for your
* eyes.

---

###Comparison at 3V| LED Color | Forward Voltage (V_f) | Works at 3V? | Power
Efficiency | | --- | --- | --- | --- | | **Red** | 1.8\text{V} - 2.0\text{V} |
Yes (Needs Resistor) | **Best** (Lowest raw power) | | **Yellow** | 2.0\text{V}
- 2.2\text{V} | Yes (Needs Resistor) | Great | | **Green** | 2.1\text{V} -
  3.2\text{V} | Yes | **Best** (Highest visibility) | | **Blue** | 3.0\text{V}
- 3.4\text{V} | Barely | Poor (High voltage) | | **White** | 3.0\text{V} -
3.4\text{V} | Barely | Poor (High voltage) |

> **Warning:** If you connect a **Blue** or **White** LED to a 3V coin cell
> (like a CR2032), it may look dim or flicker as the battery drains, because 3V
> is right at the "edge" of what those colors need to turn on. Red and Green
> will stay bright much longer as the battery dies.

Would you like me to calculate the exact resistor value you need to keep your
3V power consumption as low as possible?

[Understanding LED Forward
Voltage](https://www.youtube.com/watch?v=26nW37Cy4V8) This video explains how
forward voltage differs by color and why it dictates how much power your
circuit will draw.


--- ---

Resistor Values Use one resistor per LED (anode to 2.1V rail, cathode to common
node → MOSFET → GND).

Use high-frequency PWM (>1kHz) from nRF54L15 for flicker-free dimming. Start at
5–20% duty cycle to reduce average current further (e.g., 0.1mA peak @ 10% duty
→ 0.01mA average per LED → <1mA total average → negligible battery drain).
Prototype one LED + resistor, measure current, adjust PWM in firmware for
perfect "just visible" level.

--- ---
the resistor is mounted before the LED, on the supply side (anode side), not on
the ground side.
Correct Wiring Order (Per LED)

nPM1100 output (2.1V rail) → Current-limiting resistor → LED anode → LED
cathode → Common cathode node → Low-side N-channel MOSFET drain → MOSFET source
to GND.

This is the standard and preferred configuration.
Why Resistor on the Anode (High) Side?

Best compatibility with low-side switching
The MOSFET switches the common cathode node to ground. When the MOSFET is off,
the cathode node floats (very low leakage). With the resistor on the anode
side, no current can flow even if there's minor LED leakage — full safety for
deep sleep/battery life.

---
---


mouser: green vs yello-green leds (in the cart):

No, the Kingbright APTR3216SYCK (super bright yellow, 590nm) is not better than
your Würth 156120VS75300 (green, 573nm) for your ultra-low-power BLE keyboard
priorities. It's a decent alternative if you prefer a warmer color tone, but it
comes with trade-offs in efficiency and perceived brightness at very low
currents. Head-to-Head Comparison (Based on Datasheets)

ParameterWürth 156120VS75300 (Green)Kingbright APTR3216SYCK (Yellow)Winner &
WhyPackage1206 reverse-mount (0.6mm thick, cylindrical lens)3216 SMD
(3.2x1.6x1.05mm, flat top, water clear lens)Würth – True reverse-mount design
optimized for under-PCB placement in keyboards (light directed upward into
Gateron light pipes). Kingbright is standard top-emitting; would require
careful placement or may leak light sideways/less efficiently couple into
pipes.Wavelength/Color573nm (bright green)590nm (super bright yellow)Würth –
Closer to peak human eye sensitivity (~555nm) → appears 2–3x brighter at the
same low power/current in dark conditions. Yellow is warmer/less harsh but less
efficient perceptually.Luminous Intensity @20mATyp 30 mcdTyp 150 mcdKingbright
(brighter at high current) – But at your ~0.05–0.2mA target, scaling is
sublinear; green's better efficacy dominates for "just visible" night
glow.Forward Voltage @20mATyp 2.0VTyp 2.0VTie – Identical; both ~1.8–1.95V at
low currents → same resistor calcs at 2.1V supply.Viewing Angle140° (wide, with
lens diffusion)140° (wide)Tie – Both excellent for even spread into light pipes
(no hot spots).Efficiency at Low CurrentHigh (peak eye sensitivity)Moderate
(lower eye sensitivity at 590nm)Würth – Critical for battery life: green needs
~half the power for equivalent perceived brightness in darkness. Yellow will
require slightly higher current/PWM duty → marginally worse
runtime.Power/Battery ImpactOptimal (~0.19mW peak per LED at 0.1mA)Slightly
worse (~same electrical power, but less visible → may tempt higher
dimming)Würth – Maximizes your savings goal. Why Stick with Green (Würth)

Battery Priority: At microamp levels, green's superior luminous efficacy
(lumens/watt adjusted for eye response) means subtler visibility with less
average current—directly extending battery life in your nRF54L15 setup.
Keyboard Fit: Reverse-mount + lens makes Würth plug-and-play for Gateron
switches (even diffusion, no light bleed). Yellow looks cozy/warm (retro vibe),
but it's perceptually dimmer in low light—many users report needing more power
for yellow/amber to match green's subtlety.

If you strongly prefer yellow for aesthetics (e.g., warmer tone, less
"clinical" than green), the APTR3216SYCK is usable:

Final Recommendation: Stay with the Würth green for best battery life and night
visibility. If yellow's warmth wins you over, go for this Kingbright—but expect
a small efficiency hit. Test a few of each if possible!in markdown formatNo,
the Kingbright APTR3216SYCK (super bright yellow, 590nm) is not better than
your Würth 156120VS75300 (green, 573nm) for your ultra-low-power BLE keyboard
priorities. It's a decent alternative if you prefer a warmer color tone, but it
comes with trade-offs in efficiency and perceived brightness at very low
currents. Head-to-Head Comparison (Based on Datasheets)

ParameterWürth 156120VS75300 (Green)Kingbright APTR3216SYCK (Yellow)Winner &
WhyPackage1206 reverse-mount (0.6mm thick, cylindrical lens)3216 SMD
(3.2x1.6x1.05mm, flat top, water clear lens)Würth – True reverse-mount design
optimized for under-PCB placement in keyboards (light directed upward into
Gateron light pipes). Kingbright is standard top-emitting; would require
careful placement or may leak light sideways/less efficiently couple into
pipes.Wavelength/Color573nm (bright green)590nm (super bright yellow)Würth –
Closer to peak human eye sensitivity (~555nm) → appears 2–3x brighter at the
same low power/current in dark conditions. Yellow is warmer/less harsh but less
efficient perceptually.Luminous Intensity @20mATyp 30 mcdTyp 150 mcdKingbright
(brighter at high current) – But at your ~0.05–0.2mA target, scaling is
sublinear; green's better efficacy dominates for "just visible" night
glow.Forward Voltage @20mATyp 2.0VTyp 2.0VTie – Identical; both ~1.8–1.95V at
low currents → same resistor calcs at 2.1V supply.Viewing Angle140° (wide, with
lens diffusion)140° (wide)Tie – Both excellent for even spread into light pipes
(no hot spots).Efficiency at Low CurrentHigh (peak eye sensitivity)Moderate
(lower eye sensitivity at 590nm)Würth – Critical for battery life: green needs
~half the power for equivalent perceived brightness in darkness. Yellow will
require slightly higher current/PWM duty → marginally worse
runtime.Power/Battery ImpactOptimal (~0.19mW peak per LED at 0.1mA)Slightly
worse (~same electrical power, but less visible → may tempt higher
dimming)Würth – Maximizes your savings goal. Why Stick with Green (Würth)

Battery Priority: At microamp levels, green's superior luminous efficacy
(lumens/watt adjusted for eye response) means subtler visibility with less
average current—directly extending battery life in your nRF54L15 setup.
Keyboard Fit: Reverse-mount + lens makes Würth plug-and-play for Gateron
switches (even diffusion, no light bleed). Yellow looks cozy/warm (retro vibe),
but it's perceptually dimmer in low light—many users report needing more power
for yellow/amber to match green's subtlety.

If you strongly prefer yellow for aesthetics (e.g., warmer tone, less
"clinical" than green), the APTR3216SYCK is usable:


Final Recommendation: Stay with the Würth green for best battery life and night
visibility. If yellow's warmth wins you over, go for this Kingbright—but expect
a small efficiency hit. Test a few of each if possible!



---- ----

Recommended LED Color: Green Why Green?

Highest Luminous Efficacy: Green LEDs (typically ~520-530nm) have the highest
luminous efficacy among common colors, often exceeding 100-150 lumens/watt at
low currents. The human eye is most sensitive to green light (peak sensitivity
~555nm), so green appears brighter per unit of power compared to other colors.
Low Forward Voltage: Green LEDs have a forward voltage of ~2.0-2.2V at low
currents (0.1-1mA), lower than white or blue (~2.7-3.0V). This reduces power
consumption (Power = Vf × Current) and allows more efficient use of your 3V
supply.

Why green saves the most power Human eyes are most sensitive to green light
under low-light (scotopic/mesopic) conditions. The peak of the human eye's
sensitivity curve (photopic vision) is around 555 nm, which is pure green. This
means:

A green LED needs significantly less current than other colors to appear
equally bright to the user. At the very dim levels you plan to use (e.g.,
0.1–0.5 mA or less per LED), green will look noticeably brighter than red,
blue, or white at the same current. Conversely, to achieve the same perceived
brightness as a green LED, you would need roughly: ~2–3× more current for red
~3–5× more current for blue ~3–4× more current for white (phosphor-converted
LEDs are inherently less efficient at low currents) Real-world efficiency
ranking at low current (<1 mA) for perceived brightness:

Green (best by far) Yellow/amber or lime-green Red White Blue (worst) Typical
forward voltages (affects power slightly, but secondary to eye sensitivity)
Red: ~1.8–2.2 V Green: ~2.8–3.2 V (true green; some cheaper ones are 2.0–2.4 V
but less efficient) Blue/White: ~2.8–3.2 V Since you're running from 3 V
(nPM1100), all colors work directly with a resistor, and the small Vf
difference is dwarfed by the current savings from eye sensitivity.



---- ---- grok:

Recommended LED Color: Green Why Green?

Highest Luminous Efficacy: Green LEDs (typically ~520-530nm) have the highest
luminous efficacy among common colors, often exceeding 100-150 lumens/watt at
low currents. The human eye is most sensitive to green light (peak sensitivity
~555nm), so green appears brighter per unit of power compared to other colors.
Low Forward Voltage: Green LEDs have a forward voltage of ~2.0-2.2V at low
currents (0.1-1mA), lower than white or blue (~2.7-3.0V). This reduces power
consumption (Power = Vf × Current) and allows more efficient use of your 3V
supply. Power Savings: At very low brightness (e.g., 0.1mA per LED), green LEDs
consume ~0.2-0.22mW each, or ~14-16mW total for 72 LEDs before PWM dimming.
With PWM (e.g., 1% duty cycle), average power can drop to <0.2mW total,
maximizing battery life.

Comparison of Other Colors

Red (~620-630nm): Vf: ~1.8-2.0V (lowest among common colors). Efficacy: ~50-80
lm/W (lower than green; eye is less sensitive to red). Power: ~0.18-0.2mW per
LED at 0.1mA. Pros: Lowest Vf, slightly less power than green. Cons: Dimmer
perceived brightness at equal current; may not be as visually effective for
backlighting at very low levels.

Blue (~465-475nm): Vf: ~2.7-3.0V (higher than green/red). Efficacy: ~20-50 lm/W
(much lower; eye is less sensitive to blue). Power: ~0.27-0.3mW per LED at
0.1mA. Cons: High Vf and low efficacy make blue the least efficient for battery
life.

White (Phosphor-based): Vf: ~2.7-3.0V (similar to blue, as they use blue LED
dies with phosphor). Efficacy: ~80-120 lm/W (good, but lower than green due to
phosphor losses). Power: ~0.27-0.3mW per LED at 0.1mA. Cons: Higher Vf and
slightly lower efficacy than green; no significant battery life advantage.

Yellow/Amber (~590-595nm): Vf: ~2.0-2.2V (similar to green). Efficacy: ~40-70
lm/W (lower than green; eye less sensitive). Power: ~0.2-0.22mW per LED at
0.1mA. Cons: Less bright than green for same power; less common for
backlighting.


Practical Considerations

Green’s Visual Appeal: Green is a common choice for low-power backlighting
(e.g., in keyboards, wearables) because it’s visually distinct, clear in low
light, and doesn’t strain the eyes. It’s effective for uniform backlighting
without needing per-key effects.

Final Recommendation Choose green LEDs (520-530nm) for the best balance of
power efficiency, perceived brightness, and battery life at very low
brightness. If aesthetics or specific design constraints favor another color,
red is a close second for slightly lower power but dimmer output. Avoid blue or
white for maximum efficiency. Ensure your LEDs are rated for low-current
operation (check datasheets for efficiency at 0.1-1mA).

---- ---- grok:

Q: i have 72 leds that need to be powered from a battary through npm1100 at 3v.
leds will be turned on at very low brightness. battery saving is important.
this is a ble keyboard with nrf54l15 . what led driver do you recommend.

For your BLE keyboard setup with the nRF54L15, nPM1100 providing a stable 3V
output, 72 LEDs (likely single-color per-key backlighting), and a strong
emphasis on battery life with very low brightness operation, here's my
recommendation. Prioritize Maximum Efficiency The most power-efficient approach
is uniform global dimming rather than individual per-key control. This avoids
the quiescent current draw of multi-channel driver ICs (even in low-power
modes) and minimizes complexity while achieving excellent battery savings.
Recommended "driver": A simple low-side N-channel logic-level MOSFET with PWM
dimming from the nRF54L15.

Wiring: Connect all LED anodes directly to the 3V rail (from nPM1100). Connect
each LED cathode through its own current-limiting resistor to a common node.
Connect that common node to the drain of the MOSFET. MOSFET source to GND.
MOSFET gate driven by a PWM-capable GPIO on the nRF54L15 (it has PWM
peripherals via Zephyr/nRF Connect SDK).

Component suggestions: MOSFET: Something small and efficient like the AO3400,
SI2312, or DMG2305UX (low Rds(on), fully on at 3V gate drive, near-zero

Why this is best for your priorities: Virtually zero quiescent power draw (only
leakage, <<1µA). PWM dimming is highly efficient—no wasted power in resistors
beyond the low LED current. Total average current can be extremely low (e.g.,
<1mA average for the whole array at very dim levels). Simple, cheap, small
footprint, no I2C/SPI overhead or firmware complexity for a driver IC.
Compatible with ZMK firmware's existing backlight support (which uses simple
PWM for single-color backlighting).


This setup is common in low-power portable devices and will give you the
longest battery life.

--- --- grok:

Q: connecting led's directly to resistor will waste current, no?

No, connecting LEDs directly to the 3V rail with current-limiting resistors
doesn't meaningfully waste current in your low-brightness, battery-powered
setup—it's actually one of the most efficient approaches here.

Why Resistors Are Efficient in This Case At very low brightness (e.g.,
0.1–0.5mA per LED, as we discussed for green LEDs):

Forward voltage (Vf) for green LEDs drops to ~1.9–2.1V at these currents.
Voltage drop across each resistor: ~0.9–1.1V. Power split: ~65–70% goes to the
LED (light + minimal heat), only ~30–35% dissipates as heat in the resistor.
For 72 LEDs at 0.2mA each (total ~14.4mA peak), resistor "waste" is just ~4–5mW
total—negligible compared to the nRF54L15's BLE power draw.

With PWM dimming (e.g., 5–10% duty cycle from the MOSFET switch), average
current drops to microamps, and average power to the resistors scales down
proportionally. No extra overhead. This setup draws virtually zero quiescent
current when off (just nA leakage), maximizing battery life. Comparison to
Constant-Current LED Drivers Dedicated sink drivers (like IS31FL3236) eliminate
per-LED resistors by regulating current directly, potentially improving raw
efficiency slightly (~10–20% less drop/waste per channel at steady current).
However:

They add quiescent/operating current (typically 1–5mA when active, even at low
brightness). For your ultra-low uniform dimming, this overhead can exceed the
backlight's own power draw, shortening battery life. Extra I²C communication
adds minor MCU power cost.

In low-power battery devices (keyboards, wearables), simple resistor + global
PWM is standard for uniform backlighting precisely because it's more efficient
overall at microamp levels. Bottom Line for Your Project The resistor approach
isn't "wasting" significant current—it's optimized for your priorities (battery
saving, very low brightness, uniform lighting). The tiny heat in resistors is
far outweighed by avoiding driver IC overhead. If you later want per-key
effects, then a driver IC becomes worthwhile despite the Iq trade-off. Here's
what green LED backlighting can look like at low brightness levels (visible but
subtle in ambient light, excellent in dark conditions):
geekhack.orgwombatkeyboards.comamazon.com


If you share your exact LED model or target brightness (e.g., current per LED),
I can calculate precise resistor values and estimated battery runtime!i need
the keyboard just visible at night (very low light). not sure how much current
the green led needs. given that led forward drop is ~2v, can i set the voltage
at npm1100 to be either 2.1v or 2.7v values that it offers?For your goal of
just visible in complete darkness (very low light/night use) with maximum
battery savings, green LEDs can achieve this at extremely low
currents—typically 0.05–0.5mA per LED (often around 0.1–0.2mA for subtle
visibility without glare). Why So Low?

Green LEDs remain perceptible to the dark-adapted eye down to microamp levels
due to peak human sensitivity (~555nm). Custom keyboard builders and low-power
designs commonly run backlights at 0.1–1mA per key for "barely visible" night
modes (with PWM further reducing average current). At 0.1mA per LED → total
peak ~7.2mA for 72 LEDs → with 5–10% PWM duty cycle → average <1mA (negligible
battery impact).

Regarding nPM1100 Voltage Options The nPM1100 buck regulator offers selectable
outputs: 1.8V, 2.1V, 2.7V, or 3.0V. Typical green SMD LEDs (520–530nm) have:

Vf ~2.0–2.2V at normal currents (1–20mA). But Vf drops significantly at
ultra-low currents: often ~1.8–2.0V at 0.1mA or less.

Recommendation: Set to 2.1V (best match for efficiency here).

Provides just enough headroom for very low current without large resistor
drops/waste. At 2.1V supply and ~1.9–2.0V Vf (low current) → tiny drop across
resistor (~0.1–0.2V) → current naturally limited to microamp–low milliamp range
with moderate resistors (e.g., 1k–10kΩ). Minimizes power dissipation (almost
all power goes to the LED). Still allows PWM dimming for fine-tuning to "just
visible."

Avoid 2.7V or 3.0V for this ultra-low setup:


Don't go lower than 2.1V (e.g., 1.8V):

Many green LEDs won't reliably light (or very dimly/inconsistently) at such low
currents with only 1.8V supply.













---- ----








Q: LP5864 has min current of 2.7v as listed. if true, does itr work when
battery discharge

That is an **excellent point** and a critical check on the design viability,
especially with a $\text{LiFePO}_4$ battery. You are correct to question the
minimum operating voltage.

The Texas Instruments LP5864 has a supply voltage ($V_{CC}$) range of **2.7V to
5.5V**.

### 1. The $\text{LiFePO}_4$ Discharge Curve Check

Let's look at the voltage range of your $\text{LiFePO}_4$ (3.65V nominal)
battery:

* **Fully Charged:** $\approx 3.65\text{V}$ **Operating Plateau (Most
* Runtime):** $\approx 3.2\text{V}$ to $3.3\text{V}$ **Standard Recommended
* Cutoff:** $3.0\text{V}$ **Absolute Minimum (for safety/life):** $2.5\text{V}$
* (Though you should never let it get this low).

### 2. Analysis of $V_{CC} = 2.7\text{V}$

The minimum $V_{CC}$ of $2.7\text{V}$ for the LP5864 means the chip **will
function normally** for the majority of the battery's lifespan, but it imposes
a strict limit near the end of the discharge.

| Battery State | Typical Voltage | LP5864 Status | LED Functionality | | :---
| :--- | :--- | :--- | | **Normal Use** | $3.65\text{V}$ down to $3.0\text{V}$
| **Fully Operational** | Runs perfectly. | | **Low Battery Alert** |
$3.0\text{V}$ | **Operational** | Runs perfectly. | | **Critical Limit** |
$2.7\text{V}$ | **Guaranteed Operation Stops** | The chip may turn off or
become unstable below this. |

#### Does it work when the battery discharges?

**Yes, it works down to the safe cutoff threshold, but it limits the usable
capacity of the battery.**

1.  **Safety Margin:** The standard recommended cutoff voltage for a
$\text{LiFePO}_4$ battery to maximize its lifespan is often **$3.0\text{V}$**
or even $2.8\text{V}$.
2.  **Constraint:** Since the LP5864 requires a minimum of $2.7\text{V}$, it
forces you to implement a **system shutdown at $\approx 2.8\text{V}$**. This is
a small margin below the $3.0\text{V}$ cutoff, but still comfortably above the
chip's limit.
3.  **The "Cliff":** Remember that the $\text{LiFePO}_4$ curve is very flat,
and below $3.0\text{V}$, it drops very rapidly ("falls off a cliff"). The time
spent between $3.0\text{V}$ and $2.7\text{V}$ is minimal.

**Conclusion:** The $2.7\text{V}$ minimum is acceptable because:
* You should shut down the entire system long before the battery ever
* approaches $2.5\text{V}$. The $2.7\text{V}$ limit simply ensures your
* system's final power-down threshold must be above that value (e.g.,
* $2.8\text{V}$), which is good practice for battery health anyway.

### 3. Alternative Consideration: $\text{IS}31\text{FL}3731$ $V_{DD}$

The **IS31FL3731** has a supply voltage range of **2.7V to 5.5V** as well. This
minimum voltage of $2.7\text{V}$ is common for many 3.3V-logic ICs and does not
distinguish the two chips based on your voltage requirement.

---

The initial decision to use **Red LEDs** ($V_F \approx 2.0\text{V}$) remains
the most important step here, as $2.7\text{V}$ is still plenty of headroom to
drive the low forward voltage of Red LEDs. If you had chosen Blue or White LEDs
($V_F \approx 3.0\text{V}$ to $3.5\text{V}$), the $2.7\text{V}$ minimum would
be an immediate and fatal design flaw.

**Next Step:** Let's focus on the last major component: the **BQ21040 charger
configuration** for your $\text{LiFePO}_4$ battery, which is crucial for safety
and battery longevity. Shall we look at the schematic details for the
$R_{ISET}$ and NTC resistors?

